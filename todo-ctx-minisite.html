<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tableau TO‚ÄëDO CTx ‚Äì Mini site (fichier unique)</title>
  <style>
    :root{
      --bg:#0f0f12;        /* fond global */
      --panel:#15151b;     /* panneau */
      --text:#e5e7eb;      /* texte clair */
      --muted:#a6adbb;     /* texte att√©nu√© */
      --grid:#30303a;      /* grille */
      --head:#7ea5ff;      /* en-t√™te bleu/violet */
      --head-text:#0b1222; /* texte en-t√™te */
      --ok:#22c55e;        /* r√©alis√©e (vert) */
      --prog:#3b82f6;      /* en cours (bleu) */
      --todo:#a78bfa;      /* √† faire (violet) */
      --warning:#f59e0b;   /* accent */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans","Helvetica Neue",Arial}

    .wrap{max-width:1200px;margin:0 auto;padding:1rem}
    .legend{display:flex;align-items:center;gap:1rem;flex-wrap:wrap;margin-bottom:.75rem}
    .legend .item{display:flex;align-items:center;gap:.4rem}
    .swatch{width:18px;height:18px;border-radius:4px;display:inline-block}
    .swatch.ok{background:var(--ok)}
    .swatch.prog{background:var(--prog)}
    .swatch.todo{background:var(--todo)}
    .legend .filter{appearance:none;width:16px;height:16px;border:1px solid var(--grid);border-radius:3px;display:inline-block;position:relative;}
    .legend .filter:checked{background:var(--ok);border-color:var(--ok)}
    .legend .filter.prog:checked{background:var(--prog);border-color:var(--prog)}
    .legend .filter.todo:checked{background:var(--todo);border-color:var(--todo)}

    .toolbar{display:flex;gap:.5rem;margin:.5rem 0}
    .btn{background:#1c1c24;color:var(--text);border:1px solid var(--grid);border-radius:8px;padding:.4rem .6rem;cursor:pointer}
    .btn:hover{background:#23232c}

    table{width:100%;border-collapse:collapse;background:var(--panel);border:1px solid var(--grid)}
    thead th{background:var(--head);color:var(--head-text);font-weight:700;padding:.5rem;border-right:1px solid #6d8eea}
    thead th:last-child{border-right:none}
    tbody td{border-top:1px solid var(--grid);border-right:1px solid var(--grid);padding:.35rem}
    tbody td:last-child{border-right:none}

    .status-cell{width:90px;}
    .status{display:flex;gap:.35rem}
    .status button{width:24px;height:24px;border-radius:6px;border:1px solid var(--grid);background:#1c1c24;cursor:pointer}
    .status .ok{background:var(--ok)}
    .status .prog{background:var(--prog)}
    .status .todo{background:var(--todo)}
    .status button[aria-pressed="true"]{box-shadow:0 0 0 2px rgba(255,255,255,.15) inset}

    .input{width:100%;background:#1c1c24;color:var(--text);border:1px solid var(--grid);border-radius:6px;padding:.35rem}
    .input:focus{outline:none;border-color:#4b5563}

    .week-badge{display:inline-block;min-width:40px;text-align:center;background:#1c1c24;border:1px solid var(--grid);border-radius:6px;padding:.25rem .4rem}
    .row-hidden{display:none}

    .foot{margin-top:.75rem;color:var(--muted);font-size:.9rem}
    .tag{display:inline-block;padding:.1rem .35rem;border:1px solid var(--grid);border-radius:6px;margin-left:.4rem}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="legend" role="group" aria-label="Filtres de statut">
      <div class="item"><span class="swatch ok"></span> r√©alis√©e <input id="f-ok" type="checkbox" class="filter ok" checked title="Afficher r√©alis√©e"></div>
      <div class="item"><span class="swatch prog"></span> en cours <input id="f-prog" type="checkbox" class="filter prog" checked title="Afficher en cours"></div>
      <div class="item"><span class="swatch todo"></span> √† faire <input id="f-todo" type="checkbox" class="filter todo" checked title="Afficher √† faire"></div>
    </div>

    <div class="toolbar">
      <button id="addRow" class="btn">‚ûï Ajouter une ligne</button>
      <button id="save" class="btn">üíæ Sauvegarder</button>
      <button id="exportCsv" class="btn">‚¨áÔ∏è Export CSV</button>
      <span class="tag">DLE = Date Limite d‚ÄôEx√©cution</span>
      <span class="tag">CTx = Contr√¥le technique</span>
    </div>

    <table id="grid" aria-label="Tableau TO-DO CTx">
      <thead>
        <tr>
          <th class="status-cell">TO‚ÄëDO</th>
          <th>n¬∞ CTx</th>
          <th>Semaine</th>
          <th>DLE</th>
          <th>Date(s) CTx</th>
          <th>V√©rificateur</th>
          <th>Chantier</th>
          <th>Observation</th>
          <th>Signature</th>
        </tr>
      </thead>
      <tbody id="body"></tbody>
    </table>

    <div class="foot">Astuce¬†: modifie la/les date(s) CTx, la colonne <b>Semaine</b> se calcule automatiquement (ISO, lundi). Les donn√©es sont stock√©es localement (navigateur).</div>
  </div>

  <script>
    const body = document.getElementById('body');

    const STATUS = { OK:'ok', PROG:'prog', TODO:'todo' };
    const MONTHS=["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"];

    function startOfIsoWeek(date){const d=new Date(date);const day=d.getDay();const diff=(day===0?-6:1-day);d.setDate(d.getDate()+diff);d.setHours(0,0,0,0);return d;}
    function isoWeek(date){ const d=new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate())); const dayNum=d.getUTCDay()||7; d.setUTCDate(d.getUTCDate()+4-dayNum); const yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil(((d-yearStart)/86400000+1)/7); }

    function parseDate(str){ // formats: YYYY-MM-DD ou JJ/MM/AAAA
      if(!str) return null;
      if(/\d{4}-\d{2}-\d{2}/.test(str)){ const [y,m,d]=str.split('-').map(Number); return new Date(y,m-1,d); }
      if(/\d{1,2}\/\d{1,2}\/\d{4}/.test(str)){ const [d,m,y]=str.split('/').map(Number); return new Date(y,m-1,d); }
      return null;
    }

    function weekFromDates(val){
      // si plusieurs dates s√©par√©es par virgules, prendre la premi√®re valide
      const parts = val.split(',').map(s=>s.trim()).filter(Boolean);
      for(const p of parts){ const d=parseDate(p); if(d) return isoWeek(d); }
      return '';
    }

    function makeRow(data={}){
      const tr = document.createElement('tr');
      tr.dataset.status = data.status || STATUS.TODO;

      // status cell
      const tdStatus = document.createElement('td'); tdStatus.className='status-cell';
      const bar = document.createElement('div'); bar.className='status';
      const bOk = document.createElement('button'); bOk.className='ok'; bOk.title='R√©alis√©e'; bOk.setAttribute('aria-pressed', tr.dataset.status===STATUS.OK);
      const bProg = document.createElement('button'); bProg.className='prog'; bProg.title='En cours'; bProg.setAttribute('aria-pressed', tr.dataset.status===STATUS.PROG);
      const bTodo = document.createElement('button'); bTodo.className='todo'; bTodo.title='√Ä faire'; bTodo.setAttribute('aria-pressed', tr.dataset.status===STATUS.TODO);
      [bOk,bProg,bTodo].forEach(btn=>btn.addEventListener('click',()=>{
        tr.dataset.status = btn.className; [bOk,bProg,bTodo].forEach(b=>b.setAttribute('aria-pressed', b===btn)); applyFilters(); save();
      }));
      bar.append(bOk,bProg,bTodo); tdStatus.append(bar); tr.append(tdStatus);

      // cells helpers
      function tdInput(val=''){ const td=document.createElement('td'); const input=document.createElement('input'); input.className='input'; input.value=val||''; td.append(input); return {td,input}; }

      // n¬∞ CTx
      const cCtx = tdInput(data.ctx); tr.append(cCtx.td);
      // Semaine (badge auto)
      const tdWeek = document.createElement('td'); const wk = document.createElement('span'); wk.className='week-badge'; wk.textContent=data.semaine||''; tdWeek.append(wk); tr.append(tdWeek);
      // DLE
      const cDle = tdInput(data.dle); tr.append(cDle.td);
      // Date(s) CTx
      const cDates = tdInput(data.dates); tr.append(cDates.td);
      // V√©rificateur
      const cVerif = tdInput(data.verificateur); tr.append(cVerif.td);
      // Chantier
      const cChantier = tdInput(data.chantier); tr.append(cChantier.td);
      // Observation
      const cObs = tdInput(data.observation); tr.append(cObs.td);
      // Signature
      const cSign = tdInput(data.signature); tr.append(cSign.td);

      // auto week calc
      function updateWeek(){ wk.textContent = weekFromDates(cDates.input.value) || ''; }
      cDates.input.addEventListener('input', updateWeek); updateWeek();

      // on change save
      [cCtx.input,cDle.input,cDates.input,cVerif.input,cChantier.input,cObs.input,cSign.input].forEach(i=>i.addEventListener('input',()=>save()));

      body.append(tr);
    }

    // initial rows
    const initial = [
      {status:STATUS.PROG, ctx:'', semaine:'', dle:'', dates:'', verificateur:'', chantier:'', observation:'', signature:''},
      {status:STATUS.TODO}, {status:STATUS.TODO}, {status:STATUS.TODO},
      {status:STATUS.TODO}, {status:STATUS.TODO}, {status:STATUS.TODO}
    ];

    function save(){ const rows=[...body.querySelectorAll('tr')].map(tr=>{
      const tds = tr.querySelectorAll('td');
      return {
        status:tr.dataset.status,
        ctx:tds[1].querySelector('input').value,
        semaine:tds[2].querySelector('.week-badge').textContent,
        dle:tds[3].querySelector('input').value,
        dates:tds[4].querySelector('input').value,
        verificateur:tds[5].querySelector('input').value,
        chantier:tds[6].querySelector('input').value,
        observation:tds[7].querySelector('input').value,
        signature:tds[8].querySelector('input').value
      };
    }); localStorage.setItem('todo-ctx', JSON.stringify(rows)); }

    function load(){ const rows = JSON.parse(localStorage.getItem('todo-ctx')||'null'); if(rows && Array.isArray(rows)){ rows.forEach(r=>makeRow(r)); } else { initial.forEach(r=>makeRow(r)); } }

    function applyFilters(){ const showOk=document.getElementById('f-ok').checked; const showProg=document.getElementById('f-prog').checked; const showTodo=document.getElementById('f-todo').checked;
      [...body.querySelectorAll('tr')].forEach(tr=>{
        const st=tr.dataset.status; const visible=(st===STATUS.OK&&showOk)||(st===STATUS.PROG&&showProg)||(st===STATUS.TODO&&showTodo);
        tr.classList.toggle('row-hidden', !visible);
      });
    }

    document.getElementById('f-ok').addEventListener('change',applyFilters);
    document.getElementById('f-prog').addEventListener('change',applyFilters);
    document.getElementById('f-todo').addEventListener('change',applyFilters);

    document.getElementById('addRow').addEventListener('click',()=>{ makeRow({status:STATUS.TODO}); save(); });

    document.getElementById('save').addEventListener('click',save);

    document.getElementById('exportCsv').addEventListener('click',()=>{
      const rows=[...body.querySelectorAll('tr')].map(tr=>{
        const tds=tr.querySelectorAll('td');
        return [
          tr.dataset.status,
          tds[1].querySelector('input').value,
          tds[2].querySelector('.week-badge').textContent,
          tds[3].querySelector('input').value,
          tds[4].querySelector('input').value,
          tds[5].querySelector('input').value,
          tds[6].querySelector('input').value,
          tds[7].querySelector('input').value,
          tds[8].querySelector('input').value
        ];
      });
      const header=["STATUT","n¬∞ CTx","Semaine","DLE","Date(s) CTx","V√©rificateur","Chantier","Observation","Signature"];
      const csv=[header,...rows].map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(';')).join('
');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='todo-ctx.csv'; a.click(); URL.revokeObjectURL(a.href);
    });

    load(); applyFilters();
  </script>
</body>
</html>
